<!DOCTYPE html>
<html>
  <head>
    <title>kees websocket test client</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css" integrity="sha512-EZLkOqwILORob+p0BXZc+Vm3RgJBOe1Iq/0fiI7r/wJgzOFZMlsqTa29UEl6v6U6gsV4uIpsNZoV32YZqrCRCQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’¿</text></svg>">
  </head>

  <style>
    body {
      text-align: center;
    }

    pre {
      overflow-x: auto;
      white-space: pre-wrap;
      white-space: -moz-pre-wrap;
      white-space: -pre-wrap;
      white-space: -o-pre-wrap;
      word-wrap: break-word;
    }

    i {
      border-radius: 10px;
      padding: 10px;
      background: #efefef;
    }

    .hide { display: none }
    .gray { background: #efefef; }
    .good { color: #087F8C; }
    .bad  { color: #EE7674; }

    .ws .logs { text-align: left; }
    .event {
      padding-top: 10px;
      padding-left: 10px;
    }

    .category {
      text-transform: uppercase;
      font-weight: 800;
    }
  </style>


  <body>
    <div class="container">
      <h1>kees websocket test client</h1>

      <div class="row main">
        <div class="device six columns">
          <form id="auth">
            <label for="name">device name</label>
            <input type="text" id="name" value="browser kees client"><br>
            <label for="version">device version</label>
            <input type="text" id="version" value="v0.0.1"><br>
            <label for="controller">controller type</label>
            <input type="text" id="controller" value="sony-cdp291"><br>
            <label for="deviceToken">device token</label>
            <input type="text" id="deviceToken" value="cdplayer"><br>
          </form>

          <button id="sendAuth">auth</button>
          <button id="reset" class="hide">reset</button>


        </div>

        <div class="info six columns">
          <div class="row id"></div>
          <div class="row check hide">
            <button id="checkAuth">check auth</button>
            <i class="hide"></i>
          </div>

          <div class="row wsStart hide">
            <button id="startWS">start ws</button>
            <i class="hide"></i>
          </div>
          <hr>

          <div class="row wsAction hide">
            <button id="goodAuth">send good auth</button>
            <button id="badAuth">send bad auth</button>
          </div>
        </div>
      </div>
      <hr>

      <div class="row ws">
        <h2>logs</h2>
        <div class="row logs">
        </div>
      </div>
    </div>
  </body>


  <script>
    console.log('kees websocket test');
    var session = null;
    var ws = null;
    var logCount = 0;
    var authBtn = document.getElementById("sendAuth");
    authBtn.addEventListener('click', auth);

    var resetBtn = document.getElementById("reset");
    resetBtn.addEventListener('click', reset);


    var checkBtn = document.getElementById("checkAuth");
    checkBtn.addEventListener('click', check);
    var wsBtn = document.getElementById("startWS");   
    wsBtn.addEventListener('click', startWS);

    var gaBtn = document.getElementById("goodAuth");
    gaBtn.addEventListener('click', goodAuth);
    var baBtn = document.getElementById("badAuth");
    baBtn.addEventListener('click', badAuth);


    if (localStorage.getItem('kees')){
      console.log("session exists");
      restoreSession();
    }

    function auth(){
      console.log("Authing Device");
      var details = getDetails();
      console.log(details);

      submitAuth(details.token, details.device);
    }

    function reset(){
      console.log("clearing session");
      localStorage.removeItem("kees");

      addWSLog("auth", "reset", {});

      if (ws){
        ws.close();
      }

      var resetBtn = document.getElementById("reset");
      resetBtn.classList.add("hide");

      var id = document.querySelector(".info .id").innerHTML = '';
      var check = document.querySelector(".check");
      check.classList.add("hide");

      var wsStart = document.querySelector(".wsStart");
      wsStart.classList.add("hide");

      var icons = document.querySelectorAll(".info i").forEach(e => {
        e.classList.add("hide");
      });

      var sendAuth = document.getElementById("sendAuth");
      sendAuth.classList.remove("hide");
    }

    async function check(){
      var status = document.querySelector(".check i");
      status.classList = 'fa-solid fa-circle-notch fa-spin';

      addWSLog("auth", "check", session.jwt);

      let resp = await fetch('/ws/v1/auth/check', {
        method: "GET",
        headers: {
          'X-Kees-JWT-Token': session.jwt.token
        }
      });

      let data = await resp.json();
      console.log(data);
      addWSLog("auth", "check ack", data);
      status.classList = 'fa-solid fa-check good';
    }


    function getDetails(){
      console.log("Getting Device Details");
      var details = document.getElementById("auth")
      var deviceInfo = {
        name: details.querySelector("#name").value,
        version: details.querySelector("#version").value,
        controller: details.querySelector("#controller").value
      }

      var token = details.querySelector("#deviceToken").value;

      var payload = {
        device: deviceInfo,
        token: token
      }
      return payload;
    }

    async function submitAuth(token, payload){
      addWSLog("auth", "auth", {token: token, payload: payload});

      let resp = await fetch('/ws/v1/auth', {
        method: 'POST',
        headers: {
          'X-Kees-MC-Token': token
        },
        body: JSON.stringify(payload)
      });

      console.log(resp);

      let data = await resp.json();
      console.log(data);

      addWSLog("auth", "auth ack", data);

      localStorage.setItem('kees', JSON.stringify(data));
      restoreSession();
    }


    function restoreSession(){
      session = JSON.parse(localStorage.getItem('kees'));
      console.log(session);

    
      var sendAuth = document.getElementById("sendAuth");
      sendAuth.classList.add("hide");
      var reset = document.getElementById("reset");
      reset.classList.remove("hide");


      var details = document.getElementById("auth");
      details.querySelector("#name").value = session.device.name;
      details.querySelector("#version").value = session.device.version;
      details.querySelector("#controller").value = session.device.controller;

      var id = document.querySelector(".info .id").innerHTML = `
        <strong>device id</strong><br> ${session.device.id}
      `;

      var check = document.querySelector(".check");
      check.classList.remove("hide");

      var wsStart = document.querySelector(".wsStart");
      wsStart.classList.remove("hide");
    }

    function addWSLog(category, type, data){
      var logs = document.querySelector(".ws .logs");

      logCount++;
      var tmpl = logTemplate({
        category: category,
        type: type,
        data: data
      });

      logs.prepend(tmpl);
    }


    function logTemplate(data){
      var gray = (logCount % 2) == 0 ? 'gray' : '';
      var tmpl = `
        <div class="row event ${gray}">
          <div class="four columns">
            <div class="row category">${data.category}</div>
            <div class="row type">${data.type}</div>
            <div class="row date">${(new Date()).toLocaleString()}</div>
          </div>
          <div class="eight columns data">
            <pre>${JSON.stringify(data.data, undefined, 2)}</pre>
          </div>
        </div>
      `;

      var t = document.createElement("template");
      t.innerHTML = tmpl;
      var el = t.content.cloneNode(true);
      return el;
    }

    function startWS(){
      var status = document.querySelector(".wsStart i");
      status.classList = 'fa-solid fa-circle-notch fa-spin';

      var host = `ws://${document.location.host}/ws/v1/mc`;
      console.log(`connecting to ${host}`);
      ws = new WebSocket(host);
      console.log(ws);

      ws.onmessage = wsMessage;
      ws.onerror = wsError;
      ws.onclose = wsClose;
      ws.onopen = wsOpen;
    }

    function wsOpen(e){
      console.log("ws open");
      console.log(e);

      var status = document.querySelector(".wsStart i");
      status.classList = 'fa-solid fa-check good';

      var wsActions = document.querySelector(".wsAction");
      wsActions.classList.remove("hide");

      var ws = document.querySelector(".ws");
      ws.classList.remove("hide");

     
      var payload = {url: e.target.url};
      addWSLog("ws", "open", payload);
    }

    function wsMessage(e){
      console.log("ws message");
      console.log(e);
      var payload = JSON.parse(e.data);
      addWSLog("ws", "inbound", payload);
    }

    function wsError(e){
      console.log("ws error");
      console.log(e);
      addWSLog("ws", "error", e.data)
    }

    function wsClose(e){
      console.log("ws close");
      console.log(e);
      var payload = {reason: e.reason, code: e.code, timestamp: e.timestamp, type: e.type, clean: e.wasClean}
      addWSLog("ws", "close", payload);

      ws = null;
      var status = document.querySelector(".wsStart i");
      status.classList = 'fa-solid fa-times bad';

      var wsActions = document.querySelector(".wsAction");
      wsActions.classList.add("hide");

    }

    function badAuth(){
      badauth = {
        message: "auth",
        token: "eatmyshorts"
      }
      addWSLog("ws", "auth", badauth);
      sendWS(badauth);
    }


    function goodAuth(){
      auth = {
        message: "auth",
        data: {
          token: session.jwt.token
        }
      }

      addWSLog("ws", "auth", auth);
      sendWS(auth)
    }

    function sendWS(data){
      var payload = JSON.stringify(data);
      ws.send(payload);
    }

  </script>
</html>
